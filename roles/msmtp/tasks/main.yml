---
- name: msmtp:dependencies:install
  ansible.builtin.package:
    name: "{{ _distro_packages[ansible_distribution | lower] }}"
  vars:
    _distro_packages:
      gentoo:
        - mail-mta/msmtp
        - mail-client/mailx
        - app-misc/ca-certificates
      debian:
        - msmtp
        - msmtp-mta
        - bsd-mailx
        - ca-certificates

- name: msmtp:sendmail:get_version
  ansible.builtin.command:
    cmd: sendmail --version
  register: sendmail_version
  changed_when: false

- name: msmtp:sendmail:check_wrapper
  ansible.builtin.assert:
    that: "'msmtp' in sendmail_version.stdout_lines[0]"

- name: msmtp:config_dir:create
  ansible.builtin.file:
    path: /root/.config/msmtp
    recurse: true
    state: directory

- name: msmtp:configure
  ansible.builtin.template:
    src: msmtp/config.j2
    dest: /root/.config/msmtp/config
    mode: "0640"

- name: msmtp:mailrc:set_default
  ansible.builtin.lineinfile:
    path: /etc/mail.rc
    regexp: ^set mta=/usr/bin/msmtp$
    line: set mta=/usr/bin/msmtp

